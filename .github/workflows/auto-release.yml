name: 🚀 Auto Database Release

# Trigger when database files are pushed to feat/update branch
on:
  push:
    branches: [ feat/update ]
    paths:
      - 'database/**'

jobs:
  auto-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🔍 Checkout feat/update branch
      uses: actions/checkout@v4
      with:
        ref: feat/update
        
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📦 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install cryptography
        # Install bc calculator for compression ratio calculations
        sudo apt-get update && sudo apt-get install -y bc
        
    - name: 🔍 Find Database File
      id: find-db
      run: |
        # Look for compressed database file first
        ZIP_FILE=$(find database -name "*.zip" -type f | head -1)
        if [ -n "$ZIP_FILE" ]; then
          echo "Found compressed database: $ZIP_FILE"
          # Extract the zip file
          unzip "$ZIP_FILE" -d database/
          # Find the extracted .db file
          DB_FILE=$(find database -name "*.db" -type f | head -1)
          if [ -z "$DB_FILE" ]; then
            echo "❌ No .db file found inside the zip archive!"
            exit 1
          fi
          echo "Extracted database: $DB_FILE"
        else
          # Look for direct .db file
          DB_FILE=$(find database -name "*.db" -type f | head -1)
          if [ -z "$DB_FILE" ]; then
            echo "❌ No database file (.db or .zip) found in /database directory!"
            exit 1
          fi
          echo "Found database: $DB_FILE"
        fi
        
        echo "db_file=$DB_FILE" >> $GITHUB_OUTPUT
        echo "db_name=$(basename $DB_FILE)" >> $GITHUB_OUTPUT
        
    - name: ✅ Validate Database
      run: |
        DB_FILE="${{ steps.find-db.outputs.db_file }}"
        
        echo "📊 Validating database: $DB_FILE"
        
        # Check file exists and size
        if [ ! -f "$DB_FILE" ]; then
          echo "❌ Database file not found: $DB_FILE"
          exit 1
        fi
        
        SIZE=$(stat -c%s "$DB_FILE" 2>/dev/null || stat -f%z "$DB_FILE" 2>/dev/null || echo "0")
        if [ "$SIZE" -eq 0 ]; then
          echo "❌ Database file is empty"
          exit 1
        fi
        
        echo "📊 Database size: $SIZE bytes"
        echo "✅ Database validation passed!"
        
    - name: 🔐 Encrypt Database
      run: |
        DB_FILE="${{ steps.find-db.outputs.db_file }}"
        
        echo "🔐 Encrypting database: $DB_FILE"
        
        # Simple encryption using OpenSSL
        openssl enc -aes-256-cbc -salt -in "$DB_FILE" -out "$DB_FILE.enc" -k "$ENCRYPTION_KEY"
        
        # Replace the original file with encrypted one
        mv "$DB_FILE.enc" "$DB_FILE"
        
        echo "✅ Database encrypted successfully"
        
        # Get final encrypted file size
        ENCRYPTED_SIZE=$(stat -c%s "$DB_FILE" 2>/dev/null || stat -f%z "$DB_FILE" 2>/dev/null)
        echo "📊 Final encrypted size: $ENCRYPTED_SIZE bytes ($(echo "scale=1; $ENCRYPTED_SIZE / 1024 / 1024" | bc -l) MB)"
      env:
        ENCRYPTION_KEY: ${{ secrets.DB_ENCRYPTION_KEY }}
        
    - name:  Calculate New Version
      id: version
      run: |
        # Get the latest release version
        LATEST_VERSION=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "v0.0.0")
        echo "Latest version: $LATEST_VERSION"
        
        # Parse and increment major version
        if [[ $LATEST_VERSION =~ v([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
          MAJOR=${BASH_REMATCH[1]}
          NEW_VERSION="v$((MAJOR + 1)).0.0"
        else
          NEW_VERSION="v1.0.0"
        fi
        
        echo "New version: $NEW_VERSION"
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 🔄 Switch to main branch and update
      run: |
        DB_FILE="${{ steps.find-db.outputs.db_file }}"
        
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Switch to main branch
        git fetch origin main
        git checkout main
        
        # Copy encrypted database from feat/update
        git checkout feat/update -- "$DB_FILE"
        
        # Commit the encrypted database
        git add "$DB_FILE"
        git commit -m "🔐 Update encrypted database to ${{ steps.version.outputs.version }}"
        git push origin main
        
    - name: 🚀 Create Release
      run: |
        DB_FILE="${{ steps.find-db.outputs.db_file }}"
        DB_NAME="${{ steps.find-db.outputs.db_name }}"
        VERSION="${{ steps.version.outputs.version }}"
        
        # Get file size for release notes
        ENCRYPTED_SIZE=$(stat -c%s "$DB_FILE" 2>/dev/null || stat -f%z "$DB_FILE" 2>/dev/null)
        
        # Create release notes
        echo "## 🗄️ Database Update" > release_notes.md
        echo "" >> release_notes.md
        echo "Database has been updated with new encrypted content." >> release_notes.md
        echo "" >> release_notes.md
        echo "## 📊 Database Information" >> release_notes.md
        echo "- Updated encrypted database file" >> release_notes.md
        echo "- Version: $VERSION" >> release_notes.md
        echo "- Updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> release_notes.md
        echo "- File size: $(echo "scale=1; $ENCRYPTED_SIZE / 1024 / 1024" | bc -l) MB" >> release_notes.md
        echo "" >> release_notes.md
        echo "## 🔐 Security" >> release_notes.md
        echo "- Database is encrypted with AES-256-CBC" >> release_notes.md
        echo "- Encryption key required for decryption" >> release_notes.md
        echo "" >> release_notes.md
        echo "## 📱 Mobile App Usage" >> release_notes.md
        echo "1. App downloads the encrypted database file" >> release_notes.md
        echo "2. App automatically decrypts using the configured key" >> release_notes.md
        echo "3. Decrypted database is ready for use" >> release_notes.md
        
        # Create release with encrypted database file
        gh release create "$VERSION" \
          --title "🗄️ Database $VERSION" \
          --notes-file release_notes.md \
          --latest \
          "$DB_FILE"
        
        echo "🎉 Release created: $VERSION"
        echo "📦 Encrypted file uploaded: $DB_NAME"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 🗑️ Delete feat/update branch
      run: |
        echo "🗑️ Deleting feat/update branch"
        git push origin --delete feat/update
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}